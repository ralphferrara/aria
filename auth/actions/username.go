//||------------------------------------------------------------------------------------------------||
//|| GenerateUsername: Creates a Unique Random Username
//||------------------------------------------------------------------------------------------------||

package actions

import (
	"errors"
	"fmt"

	"base/db/models"

	"github.com/ralphferrara/aria/base/random"

	"github.com/ralphferrara/aria/app"
)

//||------------------------------------------------------------------------------------------------||
//|| GenerateUsername
//||------------------------------------------------------------------------------------------------||

func GenerateUsername() (string, error) {
	for i := 0; i < 5; i++ {
		//||------------------------------------------------------------------------------------------------||
		//|| Generate Random Username
		//||------------------------------------------------------------------------------------------------||
		username := random.RandomString(12)
		//||------------------------------------------------------------------------------------------------||
		//|| Check DB
		//||------------------------------------------------------------------------------------------------||
		var count int64
		err := app.SQLDB["main"].DB.
			Model(&models.Account{}).
			Where("account_username = ?", username).
			Count(&count).Error
		//||------------------------------------------------------------------------------------------------||
		//|| Failed
		//||------------------------------------------------------------------------------------------------||
		if err != nil {
			return "", fmt.Errorf("error checking username existence: %w", err)
		}
		//||------------------------------------------------------------------------------------------------||
		//|| Too many attempts
		//||------------------------------------------------------------------------------------------------||
		if count == 0 {
			return username, nil
		}
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Success
	//||------------------------------------------------------------------------------------------------||
	return "", errors.New("failed to generate unique username after 5 attempts")
}
